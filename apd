#!/bin/bash
# ===============================================
# Author: aliazhar < aliazhar0555@gmail.com >
# Contributor: -
# License: GNU General Public License v2.0
# ===============================================


# {[IMPORTANT]} Where PKGBUILD and clones will be stored; cDir which means 'cache directory'.
cDir=~/Packages
 
# Check if argument/package name is specified or not and argument '-h' exist.
if [[ $# -eq 0 ]] || [[ $1 == "-h" ]];
  then
    printf "Error: Wrong/Missing Options.\n\nUsage: apd [options/AUR name] \n\nOptions:\n  -h     :     Show this help message and exit. \n  -i     :     Install package after successful build.\n"
    exit 1;
fi

# Check if cache directory exists or not
if ! [[ -d $cDir ]];
  then
    printf "Error: Cache directory not found"
    printf "run 'mkdir -p $cDir' to solve it"
    exit 1;
fi

# Check whether the -s argument exists or not, install it after the package has been successfully built, if exist.
if [[ "$*" == "-i $2" ]]; 
  then
    packageName=$2
    apdParams='-si'
    msg='build and install'
  else
    packageName=$@
    apdParams='-s'
    msg='build'
fi

# Check if the directory with the package name exists or not, if it doesn't exist, clone it, if it exists go to that directory. 
if ! [[ -d $cDir/$packageName ]]; 
  then
    git -C $cDir clone https://aur.archlinux.org/$packageName
  else
    cd $cDir/$packageName
fi

# Check if there is a file with the name PKGBUILD, if not, it means the package is not available in AUR.
if [[ -e $cDir/$packageName/"PKGBUILD" ]]; 
  then
    makepkg $apdParams &&
    printf "APD has successfully $msg the packages :)\n"
  else
    rm -rf $cDir/$packageName
    printf ". . . APD Failed . . .\n"
fi
